# 2025-10-01 Bugä¿®å¤å’Œæ”¹è¿›æ€»ç»“

## ğŸ› ä¿®å¤çš„Bug

### 1. æœ€åä¸€å¼ å¡ç‰‡å®½åº¦è®¡ç®—é”™è¯¯

#### é—®é¢˜æè¿°

åœ¨å‘å³å †å ï¼ˆright-stackï¼‰æ¨¡å¼ä¸‹ï¼Œæœ€åä¸€å¼ å¡ç‰‡çš„æœ€å¤§å…è®¸å®½åº¦è®¡ç®—é”™è¯¯ã€‚ä»£ç ä»åå‘å‰è®¡ç®—`cardMaxWidths`æ•°ç»„ï¼Œå¯¼è‡´æœ€åä¸€å¼ å¡ç‰‡çš„å¯ç”¨å®½åº¦è¢«è®¡ç®—ä¸ºæ•´ä¸ªå®¹å™¨å®½åº¦ï¼Œæ²¡æœ‰è€ƒè™‘å‰é¢å¡ç‰‡å¤´éƒ¨çš„å ç”¨ã€‚

#### é”™è¯¯é€»è¾‘

```typescript
// ä»åå‘å‰éå†ï¼ˆé”™è¯¯ï¼‰
let accumulatedHeaderWidth = 0;
for (let i = state.cards.length - 1; i >= 0; i--) {
  cardMaxWidths[i] = containerWidth - accumulatedHeaderWidth;
  accumulatedHeaderWidth += state.cards[i].rightStackHeaderWidth;
}

// ç¤ºä¾‹ç»“æœï¼ˆcontainerWidth=1200, headers=[100,120,80]ï¼‰:
// card[2] (æœ€å): maxWidth = 1200 - 0 = 1200px âŒ
// card[1] (ä¸­é—´): maxWidth = 1200 - 80 = 1120px  
// card[0] (ç¬¬ä¸€): maxWidth = 1200 - 200 = 1000px
```

#### æ­£ç¡®é€»è¾‘

```typescript
// ä»å‰å‘åéå†ï¼ˆæ­£ç¡®ï¼‰
let accumulatedHeaderWidth = 0;
for (let i = 0; i < state.cards.length; i++) {
  cardMaxWidths[i] = containerWidth - accumulatedHeaderWidth;
  accumulatedHeaderWidth += state.cards[i].rightStackHeaderWidth;
}

// ç¤ºä¾‹ç»“æœï¼ˆcontainerWidth=1200, headers=[100,120,80]ï¼‰:
// card[0] (ç¬¬ä¸€): maxWidth = 1200 - 0 = 1200px
// card[1] (ä¸­é—´): maxWidth = 1200 - 100 = 1100px
// card[2] (æœ€å): maxWidth = 1200 - 220 = 980px âœ…
```

#### å½±å“

- æœ€åä¸€å¼ å¡ç‰‡å¯èƒ½ä¼šè¶…å‡ºå®¹å™¨å®½åº¦
- å¯¼è‡´å¸ƒå±€æº¢å‡ºæˆ–æ»šåŠ¨æ¡å‡ºç°
- åœ¨å®¹å™¨å®½åº¦æ¥è¿‘ä¸´ç•Œå€¼æ—¶ï¼Œæœ€åä¸€å¼ å¡ç‰‡æ— æ³•æ­£ç¡®å‹ç¼©

---

### 2. å®¹å™¨å®½åº¦ä¸è¶³æ—¶æœªè‡ªåŠ¨åˆ‡æ¢åˆ°down-stack

#### é—®é¢˜æè¿°

è‡ªåŠ¨åˆ‡æ¢é€»è¾‘åªæ£€æŸ¥äº†viewportå®½åº¦æ˜¯å¦å°äºbreakpointWidthï¼Œä½†æ²¡æœ‰æ£€æŸ¥å®¹å™¨å®½åº¦æ˜¯å¦è¶³å¤Ÿå®¹çº³æ‰€æœ‰å¡ç‰‡çš„æœ€å°å®½åº¦è¦æ±‚ã€‚

#### é”™è¯¯é€»è¾‘

```typescript
if (autoSwitchDirection && defaultStackDirection === 'right') {
  // åªæ£€æŸ¥viewportå®½åº¦
  if (viewportWidth < breakpointWidth) {
    stackDirection = 'down';
  }
  // æ²¡æœ‰æ£€æŸ¥å®¹å™¨å®½åº¦ âŒ
}
```

#### æ­£ç¡®é€»è¾‘

```typescript
if (autoSwitchDirection && defaultStackDirection === 'right') {
  // 1. é¦–å…ˆæ£€æŸ¥viewportå®½åº¦
  if (viewportWidth < breakpointWidth) {
    stackDirection = 'down';
  } else {
    // 2. ç„¶åæ£€æŸ¥å®¹å™¨å®½åº¦ï¼ˆä»å‰å‘åï¼‰
    let accumulatedHeaderWidth = 0;
    let hasInsufficientWidth = false;
    
    for (let i = 0; i < state.cards.length; i++) {
      const card = state.cards[i];
      const minContent = resolveCSSSize(card.config.minContentWidth, containerWidth, DEFAULT_MIN_CONTENT_SIZE);
      const maxAllowedWidth = containerWidth - accumulatedHeaderWidth;
      
      if (minContent > maxAllowedWidth) {
        hasInsufficientWidth = true;
        break;
      }
      
      accumulatedHeaderWidth += card.rightStackHeaderWidth;
    }
    
    if (hasInsufficientWidth) {
      stackDirection = 'down';
    }
  }
}
```

#### æµ‹è¯•åœºæ™¯

```typescript
// æµ‹è¯•ç”¨ä¾‹: viewportè¶³å¤Ÿå¤§ï¼Œä½†å®¹å™¨å¤ªçª„
setViewport(1440, 900);     // viewportå®½åº¦å……è¶³
setContainerSize(600, 1024); // å®¹å™¨å®½åº¦ä¸è¶³

// æœŸæœ›: stackDirection = 'down'
// ä¿®å¤å‰: stackDirection = 'right' âŒï¼ˆåªçœ‹viewportï¼‰
// ä¿®å¤å: stackDirection = 'down' âœ…ï¼ˆåŒæ—¶æ£€æŸ¥å®¹å™¨ï¼‰
```

---

### 3. å¤´éƒ¨åˆ‡æ¢ä¸å †å æ–¹å¼ä¸åŒæ­¥

#### é—®é¢˜æè¿°

å¤´éƒ¨çš„æ˜¾ç¤º/éšè—ç”±CSSåª’ä½“æŸ¥è¯¢ï¼ˆ`@media (max-width: 960px)`ï¼‰æ§åˆ¶ï¼Œè€Œå †å æ–¹å¼ç”±JavaScriptçš„`stackDirection`æ§åˆ¶ã€‚ä¸¤è€…ä½¿ç”¨ä¸åŒçš„åˆ¤æ–­æ ‡å‡†ï¼Œå¯èƒ½å¯¼è‡´ï¼š

- å¤´éƒ¨å·²åˆ‡æ¢ä½†å¸ƒå±€æœªåˆ‡æ¢
- å¸ƒå±€å·²åˆ‡æ¢ä½†å¤´éƒ¨æœªåˆ‡æ¢

#### æ”¹è¿›æ–¹æ¡ˆ

å°†å¤´éƒ¨åˆ‡æ¢é€»è¾‘å®Œå…¨äº¤ç»™ç»„ä»¶æ§åˆ¶ï¼Œé€šè¿‡`v-if`æŒ‡ä»¤æ ¹æ®`stackDirection`æ˜¾ç¤ºå¯¹åº”çš„å¤´éƒ¨ã€‚

```vue
<!-- ä¿®å¤å‰: CSSåª’ä½“æŸ¥è¯¢æ§åˆ¶ -->
<aside class="panel-rail"><!-- åœ¨CSSä¸­@mediaæ§åˆ¶display --></aside>
<header class="panel-header--mobile"><!-- åœ¨CSSä¸­@mediaæ§åˆ¶display --></header>

<!-- ä¿®å¤å: VueæŒ‡ä»¤æ§åˆ¶ -->
<aside v-if="stackDirection === 'right'" class="panel-rail">
  <!-- æ°´å¹³å¤´éƒ¨ï¼Œå‘å³å †å æ—¶æ˜¾ç¤º -->
</aside>
<header v-if="stackDirection === 'down'" class="panel-header--mobile">
  <!-- å‚ç›´å¤´éƒ¨ï¼Œå‘ä¸‹å †å æ—¶æ˜¾ç¤º -->
</header>
```

#### CSSå˜æ›´

```css
/* ç§»é™¤CSSä¸­çš„displayæ§åˆ¶ */
/* ä¿®å¤å‰ */
.panel-rail { display: none; }
@media (min-width: 961px) {
  .panel-rail { display: flex; }
}
@media (max-width: 960px) {
  .panel-header--mobile { display: block; }
}

/* ä¿®å¤å */
/* å¤´éƒ¨æ˜¾ç¤ºå®Œå…¨ç”±ç»„ä»¶çš„v-ifæ§åˆ¶ï¼Œä¸å†ä½¿ç”¨CSSåª’ä½“æŸ¥è¯¢ */
.panel-rail--desktop { display: flex; }
.panel-header--mobile { /* åŸºç¡€æ ·å¼ */ }
```

---

## âœ… æ”¹è¿›å’Œä¼˜åŒ–

### 1. breakpointWidthè‡ªåŠ¨è®¡ç®—

#### æ”¹è¿›è¯´æ˜

`breakpointWidth`å‚æ•°æ”¹ä¸ºå¯é€‰ï¼Œæœªæä¾›æ—¶è‡ªåŠ¨æ ¹æ®æ‰€æœ‰å¡ç‰‡çš„`minContentWidth`è®¡ç®—æœ€å¤§æ‰€éœ€å®½åº¦ã€‚

#### è®¡ç®—é€»è¾‘

```typescript
let breakpointWidth: number;
if (options.breakpointWidth != null) {
  breakpointWidth = options.breakpointWidth;
} else {
  // ä»åå‘å‰ç´¯è®¡å¤´éƒ¨å®½åº¦ï¼Œè®¡ç®—æ¯å¼ å¡ç‰‡æ‰€éœ€çš„æœ€å°å®½åº¦ï¼Œå–æœ€å¤§å€¼
  let maxRequiredWidth = 0;
  let accumulatedHeaderWidth = 0;
  
  for (let i = state.cards.length - 1; i >= 0; i--) {
    const card = state.cards[i];
    const minContent = resolveCSSSize(card.config.minContentWidth, 1280, DEFAULT_MIN_CONTENT_SIZE);
    const requiredWidth = minContent + accumulatedHeaderWidth;
    maxRequiredWidth = Math.max(maxRequiredWidth, requiredWidth);
    accumulatedHeaderWidth += card.rightStackHeaderWidth;
  }
  
  breakpointWidth = maxRequiredWidth;
}
```

#### ç¤ºä¾‹

```typescript
// 3å¼ å¡ç‰‡: minContentWidth=[500, 560, 720], headerWidth=[100, 120, 80]
// 
// card[2]: éœ€è¦ 720 + 0 = 720px
// card[1]: éœ€è¦ 560 + 80 = 640px
// card[0]: éœ€è¦ 500 + 200 = 700px
// 
// breakpointWidth = max(720, 640, 700) = 720px
```

---

### 2. ç§»é™¤ä¸å¿…è¦çš„å‚æ•°

#### dashboard-appè°ƒç”¨æ›´æ–°

```typescript
// ä¿®å¤å‰
const instance = useLayeredLayout({
  cards,
  defaultStackDirection: 'right',
  autoSwitchDirection: true,
  breakpointWidth: 960,  // âŒ æ‰‹åŠ¨æŒ‡å®š
  activeBuffer: 20
});

// ä¿®å¤å
const instance = useLayeredLayout({
  cards,
  defaultStackDirection: 'right',
  autoSwitchDirection: true,
  // breakpointWidthä¼šè‡ªåŠ¨è®¡ç®— âœ…
  activeBuffer: 20
});
```

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•

```bash
âœ“ tests/useLayeredLayout.spec.ts (2)
  âœ“ useLayeredLayout (2)
    âœ“ computes right-stack layout and updates focus
    âœ“ switches to down-stack when container is too narrow and autoSwitchDirection is enabled

Test Files  1 passed (1)
Tests  2 passed (2)
```

### æ„å»ºç»“æœ

```bash
dist/vue-layered-layout.css     1.42 kB â”‚ gzip: 0.54 kB
dist/vue-layered-layout.es.js  13.43 kB â”‚ gzip: 4.17 kB
dist/vue-layered-layout.cjs     9.71 kB â”‚ gzip: 3.50 kB
âœ“ built in 1.36s
```

---

## ğŸ“ æ–‡æ¡£æ›´æ–°

### æ›´æ–°çš„æ–‡æ¡£

1. âœ… README.md - æ·»åŠ å®Œæ•´çš„APIè¯´æ˜å’Œå®½åº¦è®¡ç®—ç¤ºä¾‹
2. âœ… CHANGELOG.md - è®°å½•v0.2.1çš„æ‰€æœ‰ä¿®å¤
3. âœ… æœ¬æ–‡æ¡£ - è¯¦ç»†çš„Bugä¿®å¤è¯´æ˜

### å¾…æ›´æ–°çš„æ–‡æ¡£

- [ ] USER_GUIDE.md - æ·»åŠ åŒå¤´éƒ¨ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹
- [ ] æŠ€æœ¯è§„æ ¼ä¹¦.md - æ›´æ–°å®½åº¦è®¡ç®—ç®—æ³•è¯´æ˜

---

## ğŸ¯ å½±å“èŒƒå›´

### ç ´åæ€§å˜æ›´

- âŒ æ— ç ´åæ€§å˜æ›´
- âœ… å‘åå…¼å®¹

### APIå˜æ›´

- `breakpointWidth`å‚æ•°æ”¹ä¸ºå¯é€‰ï¼ˆå‘åå…¼å®¹ï¼‰
- `CardConfig`æ–°å¢`stackDirection`å±æ€§ç”¨äºé¢æ¿ç»„ä»¶

### è¡Œä¸ºå˜æ›´

- æœ€åä¸€å¼ å¡ç‰‡çš„å®½åº¦è®¡ç®—æ›´å‡†ç¡®
- å®¹å™¨å®½åº¦ä¸è¶³æ—¶èƒ½æ­£ç¡®åˆ‡æ¢åˆ°down-stack
- å¤´éƒ¨åˆ‡æ¢ä¸å †å æ–¹å¼å®Œå…¨åŒæ­¥

---

## ğŸ”„ è¿ç§»æŒ‡å—

### å¯¹äºlibraryä½¿ç”¨è€…

å¦‚æœä½ ä¹‹å‰æ‰‹åŠ¨æŒ‡å®šäº†`breakpointWidth`ï¼Œå¯ä»¥å®‰å…¨åœ°ç§»é™¤å®ƒï¼š

```typescript
// æ—§ä»£ç ï¼ˆä»ç„¶æœ‰æ•ˆï¼‰
useLayeredLayout({
  cards,
  breakpointWidth: 960
});

// æ–°ä»£ç ï¼ˆæ¨èï¼‰
useLayeredLayout({
  cards
  // breakpointWidthä¼šè‡ªåŠ¨è®¡ç®—
});
```

### å¯¹äºdashboard-app

éœ€è¦åœ¨é¢æ¿ç»„ä»¶ä¸­æ·»åŠ `stackDirection`å±æ€§ï¼š

```vue
<!-- æ·»åŠ stackDirection prop -->
<script setup lang="ts">
const props = defineProps<{ 
  collapsed?: boolean; 
  mainSpan?: number;
  stackDirection?: 'right' | 'down';  // æ–°å¢
}>();
</script>

<!-- ä½¿ç”¨v-ifæ§åˆ¶å¤´éƒ¨æ˜¾ç¤º -->
<template>
  <aside v-if="stackDirection === 'right'">æ¡Œé¢å¤´éƒ¨</aside>
  <header v-if="stackDirection === 'down'">ç§»åŠ¨å¤´éƒ¨</header>
</template>
```

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡æ›´æ–°ä¿®å¤äº†3ä¸ªå…³é”®Bugï¼Œç¡®ä¿äº†å¸ƒå±€ç³»ç»Ÿçš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ï¼š

1. **å®½åº¦è®¡ç®—å‡†ç¡®** - æœ€åä¸€å¼ å¡ç‰‡èƒ½æ­£ç¡®å“åº”å®¹å™¨å®½åº¦
2. **åˆ‡æ¢é€»è¾‘å®Œå–„** - å®¹å™¨å®½åº¦å’Œviewportå®½åº¦éƒ½ä¼šè§¦å‘åˆ‡æ¢
3. **å¤´éƒ¨å¸ƒå±€åŒæ­¥** - å¤´éƒ¨æ˜¾ç¤ºä¸å †å æ–¹å¼å®Œå…¨ä¸€è‡´

æ‰€æœ‰ä¿®å¤éƒ½é€šè¿‡äº†å•å…ƒæµ‹è¯•éªŒè¯ï¼Œä¸”ä¿æŒå‘åå…¼å®¹ã€‚

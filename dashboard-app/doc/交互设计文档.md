# 交互设计文档：三面板层叠布局（更新于 2025-10-02）

## 近期更新摘要

- **activeMin 默认值来源**：面板的最小展示尺寸不再使用固定常数，桌面端改为实时采集竖向 `panel-rail` 宽度，移动端采集头部高度，均通过 `ResizeObserver` 写入 `defaultMin`。
- **激活态缓冲**：聚焦面板时附加的视觉缓冲更新为 `20px`（`ACTIVE_BUFFER`），在保证安全边距的同时减少动画行程。
- **主内容宽度约束**：`ipList` 与 `topicList` 主宽分别固定为 `500px` 与 `600px`；`messageList` 的实际宽度严格由
  $$
  \text{messageWidth} = \max\bigl(\text{containerWidth} - \text{ipHeaderWidth} - \text{topicHeaderWidth},\ 420\bigr)
  $$
  决定，并直接绑定到根节点的 `style.width` / `--panel-main-size`，取消 `min/max-width` 与 `flex-grow` 干预。
- **消息卡片截断**：消息正文在列表中默认仅渲染前 45 行，尾部附带“查看全部”按钮弹出完整内容对话框，避免长贴影响滚动性能。
- **系统提示词气泡**：系统提示词在面板内仅预览前三行，仍可通过“查看全部”按钮进入完整预览，保证系统消息不会撑高列表。
- **Markdown 展示升级**：前端引入 GitHub 官方暗色 Markdown 样式，修复代码块渲染缺失、移除标题自链接，并为所有代码块提供右上角复制按钮。
- **浮层关闭判定优化**：所有弹窗/浮层的点击关闭逻辑改为要求在背景上“按下+抬起”均发生，避免拖拽操作在面板外松开时误关闭窗口。
- **统一的过滤 / 排序控制**：触发按钮仅负责呼出浮层，桌面端仍以 `mouseenter`/`focus` 激活；浮层基于指针/焦点自行展开并在 160ms 延迟后收起，互不干扰，移动端（含窄屏触控）保持点击触发。
- **展开动画修复**：浮层动画改为基于宽度插值，锚点按钮在浮层打开时以约 180ms 的透明度渐隐并同步移除焦点，关闭后以 100ms 渐显回位；浮层使用 `transform-origin` 与 `align` 选项保持以锚点为中心的左右对称扩散，避免先前“只向单侧拉伸”的错觉。
- **浮层搬移稳定性**：当视口滚动或锚点发生重排时，浮层进入 `relocating` 态，仅保留 `left` 插值并冻结宽度，待新位置确认后再恢复展开样式，避免动画期间的错位与跳闪。

---

## 布局系统总览

### 1. 结构概览

- 根组件：`src/App.vue`
  - 提供 `App` 级别 `ResizeObserver`，将容器尺寸同步到 `usePanelLayout`。
  - 通过 `provide(PANEL_LAYOUT_HOOK_KEY, …)` 注入三个面板的表头度量上报句柄。
- 布局核心：`src/composables/panelLayout.ts`
  - 以响应式 `state` 管理 `viewport`、`container` 以及每个面板的内部尺寸。
  - `layout` 计算属性输出：面板顺序、定位偏移、主轴尺寸、`activeMin`、聚焦面板 id。

### 2. 视口与容器归一化

- `setViewport(width, height)`：
  - 根据 `BREAKPOINT = 960` 切换横向 (`horizontal`) / 纵向 (`vertical`)。
  - 在方向切换后重置内容测量，防止旧尺寸污染新方向。
- `setContainerSize(width, height)`：
  - 宽度会被钳制在 `[fallbackWidth, viewportWidth]` 内，保证不低于基于视口的回退值。
  - 当布局动画导致测得宽度短暂超过视口时，保持上一帧的有效宽度，避免聚焦切换引起主容器放大，从而保持各面板主宽稳定。
  - 横向布局下新增约束：
    $$
    \text{normalizedContainerWidth} = \max(\text{observedWidth}, \text{headerReserve} + 420)
    $$
    `headerReserve` 为 IP/Topic 两个面板的 `defaultMin.horizontal` 之和。

### 3. 主轴尺寸计算

- IP 面板：`mainSize = 500px` 与实时内容宽度取最大值，并受容器宽度上限限制。
- 话题面板：`mainSize = 600px`，其余逻辑同上。
- 消息面板：
  - `targetMessageWidth = normalizedContainerWidth - headerReserve`。
  - 最终宽度 `mainSize = max(targetMessageWidth, MIN_MESSAGE_WIDTH = 420)`。
  - 生成的样式：

  ```ts
  style.width = `${mainSize}px`;
  style['--panel-main-size'] = `${mainSize}px`;
  ```

  并拓展到 `panel-stack` 和内部 `.panel-main`，彻底移除 `flex-grow`、`min/max-width` 对消息面板的干预。

### 4. activeMin 与折叠策略

- `collapsedSpan = max(defaultMin, baseMin.horizontal)`，其中 `baseMin.horizontal = 108`。
- `activeMin = isFocused ? mainSize + 20 : collapsedSpan`。
- 横向布局中每个面板的偏移累加规则：
  $$
  \text{offset}_{n} = \sum_{i < n} \text{activeMin}_i
  $$
- 纵向布局将公式改为高度版本（替换 `width → height`, `left → top`）。

### 5. 定位与堆叠

- `panel-stack` 通过 `style.left` / `style.top` 与 `style.width` / `style.height` 完成绝对定位。
- `panel-stack--collapsed` 使用 `--panel-collapsed-main` 控制宽高，以便在非聚焦状态下保持列头尺寸。
- `layout.totalSpan` 写入 `--layout-total`，驱动 `.dashboard-grid` 的最小宽度/高度，确保滚动区域与计算一致。

---

## 过滤 / 排序控制交互

### 1. 触发与锚点

- 涉及组件：
  - `IpListPanel.vue`：IP 过滤（search）、排序（sort）。
  - `TopicListPanel.vue`：话题过滤。
- 桌面端按钮位于 `panel-rail__actions`，通过 `@mouseenter` / `@focus` / `@click` 共用 `openXXXOverlay`。
- 移动端专属按钮统一放置在 `.panel-header__actions.panel-header__actions--tools`，用点击事件与桌面逻辑复用相同的打开函数。

### 2. controlOverlay 工作流

- 数据源：`src/stores/controlOverlay.ts`
  - **`open(payload)`**：记录锚点矩形并为原触发按钮写入 `data-overlay-hidden` 与 `tabindex="-1"`，以约 180ms 透明度渐隐+禁用指针的方式移出焦点序列，同时写入文案、初始值、选项及目标宽度；浮层以折叠态显示，待指针或焦点进入时调用 `beginInteraction()` 才展开。
  - **`OverlayControl.vue`**：`Teleport` 到 `body`，指针/焦点进入时触发 `beginInteraction()`，离开则通过 `scheduleClose()` 设置约 160ms 的缓冲后再调用 `requestClose()`；响应存储中的 `relocating` 状态时，仅保留位置插值并冻结宽度，待 `transitionend` 执行 `finalize()` 后复位锚点并恢复展开动画。
  - **值同步**：`onInput` 用于实时过滤；`onCommit` / `commit()` 在 Enter、Blur 或下拉选择后持久化并复用同一关闭流程。

### 3. 动画与方向修复

- 样式文件：`OverlayControl.vue` scoped CSS。
- 关键点：
  - 初始宽度取锚点宽度或自定义 `collapsedWidth`，展开目标写入 `--overlay-expanded-width`。
  - `transition: width 0.22s cubic-bezier(0.35, 0.9, 0.3, 1)` 实现平滑插值；配合 `opacity` 过渡抑制闪烁。
  - 锚点按钮通过 `.control-button--overlay-hidden` / `data-overlay-hidden` 以约 0.18s 透明度过渡淡出，并同步移除指针事件与焦点，关闭后以 0.1s 渐显回到交互序列。
  - 处于 `.overlay-control--relocating` 时移除宽度插值，仅保留 `left`、`top`与透明度过渡，确保重新定位过程不会发生左右跳跃。
  - `overlay-control--align-right` 指定时设置 `transform-origin: top right`，使动画围绕锚点右沿展开；默认左对齐。
  - `overlayStore.refreshAnchorRect()` 窗口滚动/尺寸变化时重算位置，保证浮层持续贴合触发源。

---

## 工程实现要点与参考文件

| 模块 | 说明 | 关键文件 |
| --- | --- | --- |
| 布局计算 | 三面板主轴宽度 / 偏移、activeMin、方向切换 | `src/composables/panelLayout.ts` |
| 面板载体 | 提供 `ResizeObserver`、Class/Style 绑定、聚焦态切换 | `src/App.vue` |
| 表头度量 | 采集桌面竖向栏宽与移动头部高 | `IpListPanel.vue` / `TopicListPanel.vue` / `MessagePanel.vue` |
| 控制浮层 | Pinia 存储浮层状态、提交/取消、锚点同步 | `src/stores/controlOverlay.ts` |
| 浮层界面 | `Teleport`、动画、自动关闭策略 | `src/components/OverlayControl.vue` |
| 控件触发 | 过滤 / 排序按钮，统一 hover/点击行为 | `IpListPanel.vue`, `TopicListPanel.vue` |

---

## 参考交互示例

- **IP 过滤**：触发按钮只负责呼出控件，指针移入浮层后自动展开；输入实时触发 `dashboard.ipFilter` 更新，指针/焦点移出 160ms 后自动提交并关闭。
- **IP 排序**：浮层展开后独立管理高亮与收起节奏，选择即调用 `dashboard.ipSortKey = value` 并按延迟策略关闭，避免多控件切换时打断动画。
- **话题过滤**：仅在选中 IP 时启用，同步更新 `dashboard.topicFilter`，未选中时按钮禁用且浮层会即时取消。
- **消息面板宽度**：当 IP/Topic 栏折叠后，消息面板宽度自动扩展至容器剩余空间；即便拖拽窗口造成容器缩小，也能保证最小 420px 可读区。

本页所有描述均以 `main` 分支 2025-09-29 版本为准，如后续实现发生变化，请同步修订此文档。

